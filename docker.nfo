__DOCKERS_START__
__DOCKER_START__ name=caddy req=true
__CMD_START__
mkdir -p /docker/caddy/{conf,log}
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/caddy/docker-compose.yml
services:
  caddy:
    container_name: caddy
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    cap_add:
      - NET_ADMIN
    volumes:
      - ./conf:/etc/caddy
      - ./log:/var/log
      - data:/data
      - config:/config
    environment:
      - CLOUDFLARE_API_TOKEN=##API_TOKEN##
volumes:
  data:
  config:
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__DOCKER_END__

__DOCKER_START__ name=portainer req=true 
__CMD_START__
mkdir -p /docker/portainer
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/portainer/docker-compose.yml
version: "3.8"
services:
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - data:/data
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      - TZ=Asia/Seoul
      - PUID=0
      - PGID=0
volumes:
  data:
networks:
  default:
    external: true
    name ##DOCKER_BRIDGE_NM##
__EOF_END__

__EOF_START__ /docker/docker-all-start.sh
#!/usr/bin/env bash

cd /docker || exit 1

# ë‹¤ì¤‘ ì„œë¹„ìŠ¤ ìš´ì˜í•˜ëŠ” í´ë”
SPECIAL_DIR="ff_plex"
# ì˜ˆì™¸ì ìœ¼ë¡œ ê±´ë„ˆë›¸ í´ë”ë“¤   ("core" "backup" "testdir")
EXCLUDE_DIRS=("core")


# í•¨ìˆ˜: ì˜ˆì™¸í´ë” ì—¬ë¶€ ì²´í¬
is_excluded() {
  local dir=$1
  for e in "${EXCLUDE_DIRS[@]}"; do
    if [ "$dir" = "$e" ]; then
      return 0
    fi
  done
  return 1
}

for dir in */; do
  svc=$(basename "$dir")

  # ì˜ˆì™¸í´ë” ê±´ë„ˆëœ€
  if is_excluded "$svc"; then
    echo "-- $svc: ì˜ˆì™¸í´ë”, ê±´ë„ˆëœ€ --"
    continue
  fi

  if [ -f "$dir/docker-compose.yml" ]; then
    echo "-- $svc ì„œë¹„ìŠ¤ ì²˜ë¦¬ ì¤‘: $dir --"
    cd "$dir" || continue

    if docker compose ps -q | grep -q .; then
      echo "   -> ì»¨í…Œì´ë„ˆ ì¡´ì¬: restart ìˆ˜í–‰"
      docker compose restart
    else
      echo "   -> ì»¨í…Œì´ë„ˆ ì—†ìŒ: up -d ìˆ˜í–‰"
      docker compose up -d
    fi

    cd ..
  else
    echo "-- $svc: docker-compose.yml ì—†ìŒ, ìƒëµ --"
  fi
done

echo "ëª¨ë“  ë„ì»¤ ì„œë¹„ìŠ¤ ì²˜ë¦¬ ì™„ë£Œ."
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Portainer
    @portainer host portainer.##DOMAIN##
    handle @portainer {
        reverse_proxy portainer:9000 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=rclone req=true
__CMD_START__
mkdir -p /docker/rclone
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/rclone/docker-compose.yml
version: '3'
services:
  rclone:
    container_name: rclone
    image: ghcr.io/wiserain/rclone:mod
    restart: unless-stopped
    ports:
      - 5574:5574
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./:/config
      - ./:/log
      - /rclone/Cache:/cache
      - /rclone/Data:/data:rshared
    environment:
      - PUID=0
      - PGID=0
      - TZ=Asia/Seoul
      - RCLONE_LOG_FILE=./rclone_mount.log
      - RCLONE_LOG_LEVEL=ERROR
      - "RCLONE_REMOTE_PATH=google:"
      - RCLONE_REFRESH_ON_MOUNT
      - RCLONE_MOUNT_USER_OPTS=
        --allow-non-empty
        --drive-skip-gdocs
        --user-agent=oci-seoul
        --poll-interval=0
        --buffer-size=16M
        --vfs-read-chunk-size=16M
        --vfs-read-chunk-size-limit 2048M
        --vfs-read-ahead 32M
        --vfs-cache-mode=full
        --vfs-cache-max-size=256G
        --vfs-cache-max-age=480h
        --vfs-cache-poll-interval=5m
        --dir-cache-time=1000h
        --read-only
        --no-checksum
        --no-modtime
        --drive-gds-mode=all
        --filter-from=/config/filter.txt
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOF_START__ /docker/rclone/rclone.conf
[google]
type = drive
scope = drive
gds_userid = ##GDS_USERID##
gds_apikey = ##GDS_APIKEY##
gds_endpoint = https://api.sjva.me/v1/gds_auth
__EOF_END__
__EOF_START__ /docker/rclone/filter.txt
- Featurettes/**
__EOF_END__
__EOF_START__ /docker/rclone-after-service.sh
#!/bin/bash

# ff_plexëŠ” í•­ìƒ ì¤‘ì§€ ë° ê¸°ë™
docker stop ff 2>/dev/null &
docker stop plex 2>/dev/null &
wait
echo "[ì •ë³´] ff_plex ì„œë¹„ìŠ¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."

# kavita, jellyfinëŠ” ì¡´ì¬í•  ê²½ìš°ë§Œ ì¤‘ì§€
for service in kavita jellyfin; do
  dir="/docker/$service"
  # í´ë” ì—†ìœ¼ë©´ ì„œë¹„ìŠ¤ ì—†ìŒ ì²˜ë¦¬
  if [ ! -d "$dir" ]; then
    continue
  fi
  # í´ë” ìˆìŒ â†’ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
  if docker ps --filter "name=$service" --format '{{.Names}}' | grep -qw "$service"; then
    if docker stop "$service" 2>/dev/null; then
      echo "[ì •ë³´] $service ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
    else
      echo "[ê²½ê³ ] $service ì„œë¹„ìŠ¤ ì¤‘ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
    fi
  else
    echo "[ì •ë³´] $service ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
  fi
done

# ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë ë•Œê¹Œì§€ ëŒ€ê¸°
echo "[ì •ë³´] ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì¤‘ì§€ë  ë•Œê¹Œì§€ 5ì´ˆê°„ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
sleep 5

# /mnt/rclone/DATA/GDRIVEê°€ ë§ˆìš´íŠ¸ë  ë•Œê¹Œì§€ 5ì´ˆ ê°„ê²© ëŒ€ê¸°
echo "[ì •ë³´] /mnt/rclone/DATA/GDRIVE ë§ˆìš´íŠ¸ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤..."
while [ ! -d /mnt/rclone/DATA/GDRIVE ]; do
  sleep 5
done
echo "[ì •ë³´] /mnt/rclone/DATA/GDRIVEê°€ ë§ˆìš´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."

# I/O ì•ˆì •í™” ëŒ€ê¸°
echo "[ì •ë³´] I/O ì•ˆì •í™”ë¥¼ ìœ„í•´ 5ì´ˆê°„ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
sleep 5

# ff_plexëŠ” ë¬´ì¡°ê±´ ê¸°ë™
cd /docker/ff_plex && docker compose up -d
echo "[ì •ë³´] ff_plex ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."

# kavita, jellyfinì€ í´ë” ë° docker-compose.yml í™•ì¸ í›„ ê¸°ë™
for service in kavita jellyfin; do
  dir="/docker/$service"
  compose_file="$dir/docker-compose.yml"
  if [ -d "$dir" ] && [ -f "$compose_file" ]; then
    cd "$dir" && docker compose up -d
    echo "[ì •ë³´] $service ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
  fi
done

exit 0
__EOF_END__
__EOF_START__ /etc/systemd/system/rclone-after-service.service
[Unit]
Description=Delayed Docker Compose Start After Rclone Mount
After=network-online.target

[Service]
Type=simple
ExecStart=/docker/rclone-after-service.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
__EOF_END__
__EOFS_END__
__DOCKER_END__

__DOCKER_START__ name=ff_plex req=true
__CMD_START__
mkdir -p /docker/ff_plex/ff && mkdir -p /docker/ff_plex/plex/{config,transcode}
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/ff_plex/docker-compose.yml
version: '3'
services: 
  ff:
    container_name: ff
    image: flaskfarm/flaskfarm:4.0
    ports:
      - "9999:9999" # service port
      - "9998:9998" # webhook port (plex)
      - "9997:7575" # webhook port (jellyfin)
    volumes:
      - /docker/ff_plex/ff:/data
      - /:/host         # ë‚´ë¶€ ìš°ë¶„íˆ¬ê¹Œì§€ ì ‘ê·¼. ë¡œê·¸ì‚­ì œê°™ì€ íŠ¹ìˆ˜ê¸°ëŠ¥ë–„ë¬¸ì— í—ˆìš©
      - /mnt/rclone/Data:/share/gds:rshared
      # plex mate plex-docker
      - libpms:/usr/lib/plexmediaserver
      - /docker/ff_plex/plex:/plex
    privileged: true

  plex:
    container_name: plex
    image: ghcr.io/by275/plex:lsio-1.42.1.10060-4e8b05daf
    security_opt:
      - no-new-privileges:true
    ports:
      - 32400:32400
    volumes:
      - /docker/ff_plex/plex/config:/config
      - /docker/ff_plex/plex/transcode:/transcode
      - type: bind
        source: /mnt/rclone/Data
        target: /share/gds
        bind:
          propagation: rslave
      - libpms:/libpms
    devices:
      - "/dev/dri:/dev/dri"
    environment:
      PUID: 0
      PGID: 0
      TZ: ${TZ:-Asia/Seoul}
      PLEX_CLAIM: claim-dxqdEtTdsP_88m1ZBXE1
      VERSION: docker
      WAIT_ANCHOR_DIRS: /share/gds/GDRIVE/VIDEO/ë°©ì†¡ì¤‘
      WATCHER_DIRS: /share/gds/GDRIVE/VIDEO/ë°©ì†¡ì¤‘
      WATCHER_INTERVAL: 3600s
      CLEANUP_PTC_CRON: 44 44 */4 * * *
      CLEANUP_PTC_EXCEED_GB: 30
      CLEANUP_PTC_FREEUP_GB: 10
    logging:
      driver: json-file
      options:
        max-size: "1024k"
        max-file: "5"
volumes:
  libpms:

networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Plex Media Server + Hook
    @plex host plex.##DOMAIN##
    handle @plex {
        reverse_proxy plex:32400 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
    @plexhook host plexhook.##DOMAIN##
    handle @plexhook {
        reverse_proxy ff:9998 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDY_START__
    # FF
    @ff host ff.##DOMAIN##
    handle @ff {
        reverse_proxy ff:9999 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=jellyfin req=false
__CMD_START__
mkdir -p /docker/jellyfin/{cache,config}
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/jellyfin/docker-compose.yml
version: "3.7"
services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    devices:
      - /dev/dri:/dev/dri         # Intel/NVIDIA GPUìš© ì´ˆê¸° ì˜ˆì‹œ
    environment:
      - PUID: 0
      - PGID: 0
      - TZ=Asia/Seoul             # ì‹œê°„ëŒ€
    ports:
      - 8096:8096                 # Jellyfin ê¸°ë³¸ í¬íŠ¸
    volumes:
      - ./config:/config
      - ./cache:/cache
      - /mnt/rclone/Data/GDRIVE/VIDEO/AV:/media      # ë³¸ì¸ì˜ ë¯¸ë””ì–´ ê²½ë¡œë¡œ ìˆ˜ì •
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Jellyfin
    @jellyfin host jellyfin.##DOMAIN##
    handle @jellyfin {
        reverse_proxy jellyfin:8096 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=kavita req=false
__CMD_START__
mkdir -p /docker/kavita
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/kavita/docker-compose.yml
version: '3.3'
services:
  kavita:
    container_name: kavita
    image: ghcr.io/by275/kavita:v0.8.3.2-0.4.2
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "1024k"
        max-file: "5"
    volumes:
      - ./:/kavita/config
      - /mnt/rclone/Data:/mnt/gds2:rshared
    ports:
      - "5000:5000"
    environment:
      - PUID: 0
      - PGID: 0
      - TZ: Asia/Seoul
      - WAIT_ANCHOR_DIRS: /mnt/gds2/GDRIVE/READING
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Kavita
    @kavita host kavita.##DOMAIN##
    handle @kavita {
        reverse_proxy kavita:5000 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=beszel req=false
__CMD_START__
mkdir -p /docker/beszel
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/beszel/docker-compose.yml
version: "3.8"
services:
  beszel:
    image: henrygd/beszel:latest
    container_name: beszel
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - ./:/beszel_data
    environment:
      - TZ=Asia/Seoul
    deploy:
      resources:
        limits:
          memory: 64M
volumes:
  beszel_data:
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Beszel
    @beszel host beszel.##DOMAIN##
    handle @beszel {
        reverse_proxy beszel:8090 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=uptime-kuma req=false
__CMD_START__
mkdir -p /docker/uptime-kuma
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/uptime-kuma/docker-compose.yml
version: '3.3'
services:
  uptime-kuma:
    container_name: uptime-kuma
    image: 'louislam/uptime-kuma:latest'
    restart: unless-stopped
    ports:
        - '3001:3001'
    volumes:
        - './:/app/data'
volumes:
  data:
    driver: local
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__CADDYS_START__
__CADDY_START__
    # Uptime Kuma
    @uptime host uptime.##DOMAIN##
    handle @uptime {
        reverse_proxy uptime-kuma:3001 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_END__

__DOCKER_START__ name=vaultwarden req=false
__CMD_START__
mkdir -p /docker/vaultwarden
__CMD_END__
__EOFS_START__
__EOF_START__ /docker/vaultwarden/docker-compose.yml
version: '3.1'
services:
  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server
    restart: unless-stopped
    ports:
      - 8000:80
    volumes:
      - ./:/data
    environment:
      - TZ=Asia/Seoul
networks:
  default:
    external: true
    name: ##DOCKER_BRIDGE_NM##
__EOF_END__
__EOFS_END__
__DOCKER_END__
__CADDYS_START__
__CADDY_START__
    # Vaultwarden
    @vaultwarden host pw.##DOMAIN##
    handle @vaultwarden {
        reverse_proxy vaultwarden:80 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
__CADDY_END__
__CADDYS_END__
__DOCKER_LIST_END__

__CADDYFILE_START__ /docker/caddy/conf/Caddyfile
{
    email ##email##
}

# ì™€ì¼ë“œì¹´ë“œ ì¸ì¦ì„œë¡œ ëª¨ë“  ì„œë¸Œë„ë©”ì¸ ì²˜ë¦¬
*.##DOMAIN## {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }

    # Proxmox
    @proxmox host pve.##DOMAIN##
    handle @proxmox {
        reverse_proxy https://##PROXMOX_IP##:8006 {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }

_CADDYS_

    # ê¸°ë³¸ ì‘ë‹µ (ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ì„œë¸Œë„ë©”ì¸)
    handle {
        respond "ğŸ   Homelab Server - Service not found" 404
    }

    # ë¡œê·¸ ì„¤ì •
    log {
        output file /var/log/access.log {
            roll_size 50mb            # ë¡œê·¸ íŒŒì¼ ìµœëŒ€ í¬ê¸° (ì„ íƒ ì‚¬í•­)
            roll_keep 7               # ë³´ê´€í•  ë¡œê·¸ íŒŒì¼ ê°œìˆ˜
            roll_keep_for 720h        # ë³´ê´€ ê¸°ê°„ (ì˜ˆ: 720ì‹œê°„ = 30ì¼)
        }
        format json       # ë˜ëŠ” format console
        level INFO
    }
}

# ë©”ì¸ ë„ë©”ì¸ (ì™€ì¼ë“œì¹´ë“œì— í¬í•¨ë˜ì§€ ì•ŠìŒ)
##DOMAIN## {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }
    respond "ğŸ   Homelab Main Page - All services running!"
}
__CADDYFILE_END__
